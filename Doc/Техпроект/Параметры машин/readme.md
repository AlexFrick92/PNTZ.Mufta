# Загрузка параметров машин

1. Структурная схема обмена данными
2. Описание блоков данных в ПЛК
4. Алгоритм обмена данными

## Структурная схема обмена данными

Загрузка параметров машин из себя алгоритм передачи параметров из программы ПЛК в АРМ.

Для загрузки рабочих параметров, мы используем существующий алгоритм, для того, чтобы не менять программу ПЛК400.

Как это работает сейчас:

![](Загрузка%20параметров%20машин.drawio.svg)

1. АРМ по Ethernet при помощи протокола S7 считывает данные из ПЛК400.
2. ПЛК записывает код команды. Команда это такая же переменная как и данные в ПЛК400, которая имеет системное назначение.
3. АРМ получает команду, считывает параметры машин, отображает их на экране.
4. АРМ подтверждает параметры машин и отправляет команду в ПЛК
5. ПЛК отправляет эти параметры в EASY

Это упрощенный алгоритм, который будет подробно описан далее.

Для того, чтобы не менять программу в ПЛК400, и повторить функционал программы АРМ, изменим схему следующим образом:

![](Загрузка%20параметров%20машин%202.drawio.svg)

Выполняем связь между ПЛК400 и ПЛК1517 по Ethernet. Так как ПЛК400 - это пассивный сервер, с открытыми блоками данных, в которые записывает и читает программа АРМ, то вместо программы это будет делать ПЛК1517.

ПЛК1517 и программу АРМ свяжем по OPC UA. Напоминаю, что это уже новая программа АРМ.

Алгоритм загрузки рабочих данных мы повторяем в программе АРМ, а в ПЛК400 оставляем неизменным.

**Здесь не рассматривается обмен ПЛК400 и Easy, который так же должен быть изменён.**

## Описание блоков данных в ПЛК

В ПЛК400 есть следующие блоки данных, которые учавствуют в обмене рабочими параметрами:

- **DB701 : MP_OP_SPS** (DB801 : (2)MP_OP_SPS)- Блок данных, из которого АРМ считывает параметры машин
- **DB400 : KOM_REG_SP** (DB450 : (2)KOM_REG) - Блок данных, в котором хранятся команды 

Блок данных DB400 имеет много переменных - команд, но в алгоритме загрузки рецепта используются две:
1. DB400 : KOM_REG.SPS_TPC_MDAT.CMD_TPC - команда от ПЛК в АРМ
2. DB400 : KOM_REG.SPS_TPC_MDAT.TPC_PLC - команда от АРМ в ПЛК

Блок DB701 имеет следующую структуру:
```
MP_Load_Cell_Span	    Real            Диапазон значений / Einheitenbereich Messzelle / Range Load Cell Span /
MP_Load_Span_Digits	    Real            Разрешение измерительной ячейк / Auflцsung Messzelle / Range Load Cell Digit /
MP_Handle_Length	    Real            Диапазон Длина ручки / Hebelarmlдnge Messzelle / Range Handle Length
MP_Handle_Length_Digits	Real            Диапазон длины ручки / Auflцsung Hebelarm Messzelle / Range Handle Length Digit
MP_TC_PPR	            Real
MP_Box_Length	        Real            Messbereich Muffenlдnge / Range Box Length Measure System
MP_Box_Length_Digit	    Real    
MP_Makeup_Length	    Real            Messbereich Verschraublдnge / Range Makeup Length Measure System
MP_Makeup_Length_Digits	Real
MP_Tq_Max	            Real            Maximales Drehmoment Maschine / Max Torque Value Machine
MP_Machine_No	        String[20]      Maschinen Nummer / Machine No.
MP_Cal_Factor	        Real            Калибровочный коэффициент
MP_Cal_User	            String[20]      Bearbeiter Kalibrierung / User, who did calibration
MP_Cal_Timestamp	    Date_And_Time   Zeitstempel Kalibrierung / Calibration Timestamp
MP_Makeup_Length_Offset	Real            Referenzwert Lдngenmassstab Verschraublдnge

```

В ПЛК1517 создаем блоки данных с такими же символьными именами. По ним АРМ будет обращаться через OPC UA.

## Алгоритм обмена данными

АРМ загружает данные в ПЛК затем записывает команду в ПЛК. 

ПЛК реагирует на команду и выполняет некоторый алгоритм, сохраняя данные рецепта и передавая их в EASY.

Весь перечень команд:
```
TPC_CMD     PLC_CMD     КОММЕНТАРИЙ

            5           ЗАПРОС ПРОВЕРКИ ПАРАМЕТРОВ МАШИН
10                      ПАРАМЕТРЫ МАШИН КОРРЕКТНЫ
            20          ПАРАМЕТРЫ ЗАГРУЖАЮТСЯ
40                      ???
            50          ПРИНЯТО
0                       ОКОНЧАНИЕ ПРОЦЕДУРЫ
            0           ОКОНЧАНИЕ ПРОЦЕДУРЫ
```

