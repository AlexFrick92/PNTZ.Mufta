# Запись оперативных параметров

1. Структурная схема 
2. Описание блоков данных в ПЛК
3. Представление меток времени в OPC UA
4. Алгоритм обмена командами
5. Алгоритм обмена данными с датчиков


## Структурная схема

Запись оперативных параметров - этот процесс начинается при запуске силовой навёртки, а завершается после останова навёртки или истечения максимального времени навёртки. 

Основная задача - снять показания датчиков

- Момент затягивания
- Обороты
- Длина свинчивания

![](Запись%20оперативных%20данных%201.drawio.svg)


1. АРМ считывает команды из блока данных
2. Когда появляется труба на позиции, ПЛК записывает команду в блок
3. АРМ видит, что ПЛК сообщил о трубе и создаёт новое соединение. Отправляет команду в блок.
4. ПЛК переходит к этапу навертки
5. После окончания свинчивания, ПЛК отправляет команду и ждет оценку от АРМ
6. АРМ присылает оценку

Это упрощенный алгоритм, который будет подробно описан далее.

Для того, чтобы не менять программу в ПЛК400, и повторить функционал программы АРМ, изменим схему следующим образом:

![](Запись%20оперативных%20данных%202.drawio.svg)

**Здесь не рассматривается обмен ПЛК400 и Easy, который так же должен быть изменён.**

Выполняем связь между ПЛК400 и ПЛК1517 по Ethernet. Так как ПЛК400 - это пассивный сервер, с открытыми блоками данных, в которые записывает и читает программа АРМ, то вместо программы это будет делать ПЛК1517.

ПЛК1517 и программу АРМ свяжем по OPC UA. Напоминаю, что это уже новая программа АРМ.

Алгоритм загрузки рабочих данных мы повторяем в программе АРМ, а в ПЛК400 оставляем неизменным.

## Описание блоков данных в ПЛК

В ПЛК400 есть следующие блоки данных, которые учавствуют в обмене рабочими параметрами:

- **DB406 : REZ_TPC_UP** (DB456 : (2)REZ_TPC_UP) - Блок с результатами операций (измерение муфты, преднавёртка, силовая навёртка). Из этого блока АРМ получает результаты, и в этот блок АРМ записывает свою оценку.
- **DB400 : KOM_REG** (DB450 : (2)KOM_REG) - Блок данных, в котором хранятся команды 

Блок данных DB700 имеет много переменных - команд, но в алгоритме загрузки рецепта используются две:
1. DB400 : KOM_REG.CAM_CMD_PLC - команда от ПЛК в АРМ
2. DB400 : KOM_REG.CAM_CMD_TPC - команда от АРМ в ПЛК

В блоке DB406 находится следующая структура:
```
- REZ_ALLG :    "REZ_ALLG" – Общие данные                   //Эту структуру мы не передаём
- REZ_Muffe :   "REZ_Muffe" – Данные для муфты              //Эту структуру мы не передаём
- REZ_MVS :     "REZ_MVS" – Данные для преднавёртки         //Эту структуру мы не передаём
- REZ_CAM :     "REZ_CAM" – Данные для силовой навертки     //Эту структуру мы не передаём
- ERG_Muffe :   "ERG_Muffe" – Результат измерения муфты         
- ERG_MVS :     "ERG_MVS" – Результат преднавёртки          
- ERG_CAM :     "ERG_CAM" – Результат силовой навёртки      
- ZEITSTEMPEL : "REZ_ZST" – Метки времени.                 
```

Видим, что есть 3 структуры, которые начинаются с префиксом ERG и одна структура REZ_ZST. Эти структуры хранят результаты операций, которые заполняются программой ПЛК.
Для отправки данных в АРМ, нам нужны последние 4 структуры:


Рассмотрим детально каждую структуру:

**"ERG_Muffe" – Результат измерения муфты**
```
PMR_BOX_RESULT	    DWORD	        (2=NIO, 1=IO)	Результат измерения муфты?
PMR_BOX_LEN_BEGIN   DATE_AND_TIME   Время начала измерения муфты?
PMR_BOX_LEN_END	    DATE_AND_TIME	Время окончания?
PMR_BOX_LEN_VALUE   REAL	        Длина муфты?
PMR_BOX_RES_00      REAL		    Вероятно резерв?
PMR_BOX_RES_01      INT		        Вероятно резерв?
```
**"ERG_MVS" – Результат преднавёртки**
```
PMR_Pre_MAKEUP_RESULT   DWORD	        (2=NIO, 1=IO)	Результат предварительного свинчивания?
PMR_Pre_MAKEUP_BEGIN    DATE_AND_TIME   Время начала предварительного свинчивания?
PMR_Pre_MAKEUP_END      DATE_AND_TIME	Время окончания предварительного свинчивания?
PMR_PIPE_POS            DWORD	        (2=NIO, 1=IO)	Результат позиционирования трубы?
PMR_Pre_MAKEUP_LEN      REAL	        Длина предварительного свинчивания?
PMR_PIPE_POS_LEN        REAL	        Позиция трубы после предварительного свинчивания?
PMR_PRE_MAKEUP_RES_00   REAL		    Вероятно резерв?
PMR_PRE_MAKEUP_RES_01   DINT		    Вероятно резерв?
```
**"ERG_CAM" – Результат силовой навёртки**
```
PMR_MR_MAKEUP_RESULT    DWORD	        (2=NIO, 1=IO)	Результат силового свинчивания в системе ПЛК. 
                                        Видимо если свинчивания не произведено (недудачное измерение муфты или преднавёртки), то ПЛК присваивает свой результат
PMR_MR_MAKEUP_BEGIN	    DATE_AND_TIME	Время начала силового свинчивания?
PMR_MR_MAKEUP_END       DATE_AND_TIME   Время окончания силового свинчивания?
PMR_MR_TOTAL_RESULT     DWORD	        (2=NIO, 1=IO)	Еще один результат? Вероятно, что это оценка уже по параметрам (момент, длина, заплечник и т.д),
PMR_MR_MAKEUP_LEN       REAL	        Длина силового свинчивания
PMR_MR_TOTAL_MAKEUP_LEN	REAL	        Общая длина (преднавертка + силовое свинчивание)
PMR_MR_MAKEUP_FIN_TQ    REAL	        Окончательный Момент силовой навертки
PMR_MR_MAKEUP_FIN_TN    REAL	        Окончательное количество оборотов силовой навертки
PMR_MR_TOTAL_MAKEUP_VAL	REAL            Окончательное значение J силовой навертки
PMR_MR_RES_0            REAL		    Вероятно резерв?
PMR_MR_RES_01           REAL		    Вероятно резерв?
PMR_MR_RES_02           REAL		    Вероятно резерв?
PMR_MR_RES_03           REAL		    Вероятно резерв?
PMR_MR_RES_04           REAL		    Вероятно резерв?
PMR_MR_RES_05           REAL		    Вероятно резерв?
PMR_MR_RES_06           WORD		    Вероятно резерв?
```
**"REZ_ZST" – Метки времени.**
```
GENERAL_TS      DATE_AND_TIME	Общая
BOX_TS          DATE_AND_TIME	Измерение муфты
PREMAKEUP_TS    DATE_AND_TIME	Преднавёртка
MAKEUP_TS       DATE_AND_TIME	Силовая навёртка
DATE_14	        DATE_AND_TIME		
```

В ПЛК1517 создаём блоки данных с такими же символьными именами. По этим символьным именам программа будет обращаться через протокол OPC UA.

## Представление меток времени в OPC UA

В программе ПЛК400 метки времени представлены как DATE_ADN_TIME. Этот тип в OPC UA ни что иное, как набор байт. 

Чтобы в OPC UA можно было считать время, в программе ПЛК1517 метки времени нужно создавать с типом DTL и выполнить конвертацию DATE_AND_TIME в DTL.


## Алгоритм обмена данными

АРМ загружает данные в ПЛК затем записывает команду в ПЛК. 

ПЛК реагирует на команду и выполняет некоторый алгоритм, сохраняя данные рецепта и передавая их в EASY.

Весь перечень команд:

ОСНОВНОЙ АЛГОРИТМ ОБМЕНА
```
TPC_CMD     PLC_CMD     КОММЕНТАРИЙ
            10          ПРИШЛА ТРУБА. НОВОЕ СОЕДИНЕНИЕ
20                      СОЗДАЛ СОЕДИНЕНИЕ. ГОТОВ К ЗАПИСИ
            30          ТРУБА В АППАРАТЕ. СВИНЧИВАНИЕ НАЧАТО
38                      СВИНЧИВАНИЕ ЗАВЕРШЕНО. ЖДУ РЕЗУЛЬТАТОВ
            40          СВИНЧИВАНИЕ ЗАВЕРШЕНО. РЕЗУЛЬТАТЫ ПОДГОТОВЛЕНЫ. ЖДУ ОЦЕНКИ
50                      ОЦЕНКА ЗАГРУЖЕНА    
            0           СВИНЧИВАНИЕ ЗАВЕРШЕНО
0                       СВИНЧИВАНИЕ ЗАВЕРШЕНО
```
ОШИБКА ПРЕДНАВЕРТКИ
```
TPC_CMD     PLC_CMD     КОММЕНТАРИЙ
            10
20          
            28          ОШИБКА ПРЕДНАВЁРТКИ
50                      ПОНЯЛ. ЗАФИКСИРОВАЛ
            0
0                                    
```
ДРУГАЯ ОШИБКА ПЛК. НАПРИМЕР СМЕНА РЕЖИМА РАБОТЫ
```
TPC_CMD     PLC_CMD     КОММЕНТАРИЙ
            10
20
            36          ОШИБКА. ВЫКЛЮЧАЙ
0           
            0
```
ОШИБКА АРМа
```
TPC_CMD     PLC_CMD     КОММЕНТАРИЙ
            10
35                      У МЕНЯ ОШИБКА. НЕ МОГУ ЗАПИСЫВАТЬ
            36          ПОНЯЛ
0
            0            
```
## Алгоритм обмена данными с датчиков

Ранее, датчики подключались к EASY, а на АРМ передавались по интерфейсу CAN. CAN - быстрый интерфейс, и, судя по графикам, там были показания с периодичностью до нескольких миллисекунд.

ПЛК 1517 позволяет отдавать данные через OPC UA с периодичностью 10 мс. 10 мс - внутреннее ограничение OPC UA для этого ПЛК.

Есть версия, что плата преобразования для усилия может передавать показания раз в 2 мс. Учитывая это, подготовим очередть в форме массива на ПЛК1517. В эту очередь, ПЛК раз в 2 мс будет записывать новые показания с датчиков.
OPC UA передает раз в 10 мс весь массив в АРМ. АРМ отрисовывает полученные показания.

В ПЛК1517 создадим блок данных для регистрации оперативных параметров:

**JointOperationalParams** - блок данных с регистрацией оперативных параметров, содержит следующую структуру
```
Torque      REAL[0..4]      Массив - очередь значений момента затяжки
Turns       REAL[0..4]      Массив - очередь значений оборотов муфты
Length      REAL[0..4]      Массив - очередь значений длины соединения
```

Раз в 2 мс ПЛК выполняет следующий алгоритм:
```c#
//Сдвиг значений в массиве
for(int i = 4; i > 0; i-- )
    Torque[i] := Torque[i - 1]

Torque[0] := TorqueSensorValue //Записать значение датчика
```

Значения длины, оборотов, и момента необходимо преобразовать в значения технологические, по которым можно оценивать соединение.
