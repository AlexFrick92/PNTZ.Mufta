# Загрузка рабочих данных

1. Структурная схема обмена данными
2. Описание блоков данных в ПЛК
4. Алгоритм обмена данными

## Структурная схема обмена данными
Загрузка рабочих данных представляет из себя алгоритм передачи параметров из программы АРМ в ПЛК.

Для загрузки рабочих параметров, мы используем существующий алгоритм, для того, чтобы не менять программу ПЛК400.

Как это работает сейчас:

![-](Загрузка%20рабочих%20данных%201.drawio.svg)

1. АРМ по Ethernet при помощи протокола S7 записывает данные в ПЛК400.
Это рабочие данные, которые будут описаны ниже.

1. АРМ записывает код команды в ПЛК400. Команда это такая же переменная как и данные в ПЛК400, которая имеет системное назначение.

2. ПЛК400 обрабатывает команду, отправляет необходимую информацию в EASY, и записывает другой код в другую переменную команды.

3. АРМ считывает этот код.

Это упрощенный алгоритм, который будет подробно описан далее.

Для того, чтобы не менять программу в ПЛК400, и повторить функционал программы АРМ, изменим схему следующим образом:

![-](Загрузка%20рабочих%20данных%202.drawio.svg)

Выполняем связь между ПЛК400 и ПЛК1517 по Ethernet. Так как ПЛК400 - это пассивный сервер, с открытыми блоками данных, в которые записывает и читает программа АРМ, то вместо программы это будет делать ПЛК1517.

ПЛК1517 и программу АРМ свяжем по OPC UA. Напоминаю, что это уже новая программа АРМ.

Алгоритм загрузки рабочих данных мы повторяем в программе АРМ, а в ПЛК400 оставляем неизменным.

**Здесь не рассматривается обмен ПЛК400 и Easy, который так же должен быть изменён.**

## Описание блоков данных в ПЛК

В ПЛК400 есть следующие блоки данных, которые учавствуют в обмене рабочими параметрами:

- **DB401 : REZ_TPC_DOWN** (DB450 : REZ_TPC_DOWN)- Блок данных, в который загружаются рабочие параметры
- **DB700 : KOM_REG_SP** (DB800 : (2)KOM_REG_SP) - Блок данных, в котором хранятся команды 

Блок данных DB700 имеет много переменных - команд, но в алгоритме загрузки рецепта используются две:
- TPC_CMD_REZ_TPC_SP - Команда TPC на загрузку рецепта
- TPC_CMD_REZ_PLC_SP - Ответ ПЛК на загрузку рецепта

В блоке DB401 находится следующая структура:

- REZ_ALLG : "REZ_ALLG" – Общие данные
- REZ_Muffe : "REZ_Muffe" – Данные для муфты
- REZ_MVS : "REZ_MVS" – Данные для преднавёртки
- REZ_CAM : "REZ_CAM" – Данные для силовой навертки
- ERG_Muffe : "ERG_Muffe" – Результат измерения муфты
- ERG_MVS : "ERG_MVS" – Результат преднавёртки
- ERG_CAM : "ERG_CAM" – Результат силовой навёртки
- ZEITSTEMPEL : "REZ_ZST" – Метки времени.

Видим, что есть 3 структуры, которые начинаются с префиксом ERG и одна структура REZ_ZST. Эти структуры заполняются дальше, программой ПЛК, но блок имеет универсальную структуру. Это сделано для того, чтобы блоки можно было копировать из одного в другой специальной функцией.

Чтобы не мудрить, скопируем и мы весь этот блок из ПЛК1517 в ПЛК400.

Рассмотрим детально каждую структуру:

**"REZ_ALLG" – Общие данные**
```
HEAD_OPEN_PULSES    REAL        Обороты на открытие навёрточной головки. Поворачивается, 
                                поканаверточная головка открыта. 
TURNS_BREAK         REAL        Turns after Breakout Обороты на развинчивание. 
                                Поворачивается пока не завершено развинчивание 
PLC_PROG_NR         WORD        PLC Programm Nummer	???  
LOG_NO              WORD        Log Nummer	???  
Tq_UNIT             WORD        0=Nm; 1=ft-lbs. Единицы измерения момента: Нм, фут-фунт
Thread_type         WORD        1=Right Hand; 2=Left Hand	
                                Направление резьбы: Правосторонняя, левосторонняя
PIPE_TYPE	        STRING[20]  Pipe Type (ASCII)	Тип трубы 
Rez_ALLG_RES	    WORD        Резерв
```

**"REZ_Muffe" – Данные для муфты**
```
Box_Moni_Time	    DINT	    Время наблюдения (10 с)
Box_Len_Min	        REAL	    Минимальная длина муфты
Box_Len_Max	        REAL	    Максимальная длина муфты
RET_MUFFE_RES_00	REAL		Вероятно резерв
RET_MUFFE_RES_01	REAL		Вероятно резерв
```
**"REZ_MVS" – Данные для преднавёртки**
```
Pre_Moni_Time       DINT	    Время наблюдения?
Pre_Len_Min		    REAL        Минимальная длина
Pre_Len_Max		    REAL    	Максимальная длина
Pre_VS_RES_00		REAL        Вероятно резерв
Pre_VS_RES_01		REAL        Вероятно резерв
```
**"REZ_CAM" – Данные для силовой навертки**
```
MU_Moni_Time	    DINT	    Время наблюдения
MU_Tq_Ref	        REAL	    Базовый крутящий момент
MU_Makeup_Mode	    WORD	    Makeup Mode: 0=By Torque, 1=By Length, 2=ByJValue	
                                Режим свинчивания (программа)
MU_TqSpeed_Red_1	REAL	    Снижение скорости при достижении крутящего момента 1
MU_TqSpeed_Red_2	REAL	    Снижение скорости при достижении крутящего момента 2
MU_Tq_Dump	        REAL        Значение крутящего момента при котором производится останов свинчивания
MU_Tq_Max	        REAL    	Максимальный крутящий момент
MU_Tq_Min	        REAL    	Минимальный крутящий момент
MU_Len_Speed_1	    REAL    	Снижение скорости при достижении длины 1
MU_Len_Speed_2	    REAL    	Снижение скорости при достижении длины 2
MU_Len_Dump	        REAL    	Значение длины свинчивания при котором производится сброс(остановка)
Mu_Len_Min	        REAL    	Минимальная длина свинчивания
Mu_Len_Max	        REAL    	Максимальная длина свинчивания
MU_JVal_Speed_1	    REAL    	Уменьшение скорости при достижениии значения J 1
MU_JVAL_Speed_2	    REAL    	Снижение скорости при достижении значения J2
MU_JVAL_Dump    	REAL    	Значение J при котором выполняется останов свинчивания
MU_JVal_Min	        REAL    	Минимальное значение J
MU_JVal_Max	        REAL    	Максимальное значение J
MU_Tq_Save	        REAL    	Крутящий момент автосохранения
MU_RES_01       	REAL    	Вероятно резерв
MU_RES_02	        INT 		Вероятно резерв
```

**"ERG_Muffe" – Результат измерения муфты**
```
PMR_BOX_RESULT	    DWORD	        (2=NIO, 1=IO)	Результат измерения муфты?
PMR_BOX_LEN_BEGIN	DATE_AND_TIME   Время начала измерения муфты?
PMR_BOX_LEN_END	    DATE_AND_TIME	Время окончания?
PMR_BOX_LEN_VALUE	REAL	        Длина муфты?
PMR_BOX_RES_00	    REAL		    Вероятно резерв?
PMR_BOX_RES_01	    INT		        Вероятно резерв?
```
**"ERG_MVS" – Результат преднавёртки**
```
PMR_Pre_MAKEUP_RESULT	DWORD	        (2=NIO, 1=IO)	Результат предварительного свинчивания?
PMR_Pre_MAKEUP_BEGIN	DATE_AND_TIME   Время начала предварительного свинчивания?
PMR_Pre_MAKEUP_END	    DATE_AND_TIME	Время окончания предварительного свинчивания?
PMR_PIPE_POS	        DWORD	        (2=NIO, 1=IO)	Результат позиционирования трубы?
PMR_Pre_MAKEUP_LEN	    REAL	        Длина предварительного свинчивания?
PMR_PIPE_POS_LEN	    REAL	        Позиция трубы после предварительного свинчивания?
PMR_PRE_MAKEUP_RES_00	REAL		    Вероятно резерв?
PMR_PRE_MAKEUP_RES_01	DINT		    Вероятно резерв?
```
**"ERG_CAM" – Результат силовой навёртки**
```
PMR_MR_MAKEUP_RESULT	DWORD	        (2=NIO, 1=IO)	Результат силового свинчивания в системе ПЛК. 
                                        Видимо если свинчивания не произведено (недудачное измерение муфты или преднавёртки), то ПЛК присваивает свой результат
PMR_MR_MAKEUP_BEGIN	    DATE_AND_TIME	Timestamp Begin Makeup	Время начала силового свинчивания?
PMR_MR_MAKEUP_END	    DATE_AND_TIME   Timestamp End Makeup	Время окончания силового свинчивания?
PMR_MR_TOTAL_RESULT	    DWORD	        (2=NIO, 1=IO)	Еще один результат? Вероятно, что это оценка уже по параметрам (момент, длина, заплечник и т.д),
PMR_MR_MAKEUP_LEN	    REAL	        Makeup Length Value	 Длина силового свинчивания
PMR_MR_TOTAL_MAKEUP_LEN	REAL	        Total Make up Length (Pre Makeup + Makeup Length)	Общая длина (преднавертка + силовое свинчивание)
PMR_MR_MAKEUP_FIN_TQ	REAL	        Verschraubung Drehmoment Endwert	Окончательный Момент силовой навертки
PMR_MR_MAKEUP_FIN_TN	REAL	        Verschraubung Drehgeber Endwert	Окончательное количество оборотов силовой навертки
PMR_MR_TOTAL_MAKEUP_VAL	REAL            Ergebnis Verschraubweg J-Value	Окончательное значение J силовой навертки
PMR_MR_RES_0	        REAL		    Вероятно резерв?
PMR_MR_RES_01	        REAL		    Вероятно резерв?
PMR_MR_RES_02	        REAL		    Вероятно резерв?
PMR_MR_RES_03	        REAL		    Вероятно резерв?
PMR_MR_RES_04	        REAL		    Вероятно резерв?
PMR_MR_RES_05	        REAL		    Вероятно резерв?
PMR_MR_RES_06	        WORD		    Вероятно резерв?
```
**"REZ_ZST" – Метки времени.**
```
GENERAL_TS	    DATE_AND_TIME	Общая
BOX_TS	        DATE_AND_TIME	Измерение муфты
PREMAKEUP_TS	DATE_AND_TIME	Преднавёртка
MAKEUP_TS	    DATE_AND_TIME	Силовая навёртка
DATE_14	        DATE_AND_TIME		

```

В ПЛК1517 создаём блоки данных с такими же символьными именами. По этим символьным именам программа будет обращаться через протокол OPC UA.

## Алгоритм обмена данными


